<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats of match</title>
    <link rel="stylesheet" href="css/base.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        :root { --bg:#0b0f14; --panel:#121822; --muted:#99a3ad; --text:#e6edf3; --accent:#5cc8ff; }
        body{background:var(--bg);color:var(--text);margin:0;padding:0;font-family:sans-serif}
        header{padding:20px;text-align:center;background:#121822}
        .dados{padding:20px}
        h1,h2{margin:6px 0}
        .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;padding:20px}
        .card{grid-column:span 12;background:var(--panel);border-radius:12px;padding:12px}
        .card h2{margin:0 0 8px;font-size:16px}
        .card svg{width:100%;height:auto;display:block}
        .card.small{grid-column:span 6}
        .card.third{grid-column:span 4}
        @media(max-width:900px){.card.small,.card.third{grid-column:span 12}}
        .tooltip{position:fixed;pointer-events:none;background:#0e1622;color:#e6edf3;border:1px solid #1e2633;border-radius:10px;padding:8px 10px;font-size:12px;opacity:0;transform:translate(-50%,-120%);white-space:nowrap;z-index:10}
        .timeaz{color: #3b82f6;}
        .timever{color: #f97316;}
    </style>
</head>
<body>
    <header>
        <h1 class="rubik-700 texto">cricket live stats</h1>
    </header>

    <div class="dados">
        <h1 class="rubik-500 texto" > Dados da partida: </h1>
        <h2 class="rubik-500 texto" id="matchTitle">Jogo:  </h2>
        <h2 class="rubik-500 texto" id="status"> Status: </h2>
        <h2 class="rubik-500 texto" id="idJogo"> ID: </h2>
        <h2 class="rubik-500 texto" id="teams"> Times: </h2>
    </div>

    <main class="grid">
        <section class="card small" id="teamPerformance">
            <h2>Desempenho dos Times</h2>
            <svg viewBox="0 0 900 320"></svg>
        </section>
        <section class="card small" id="overPerformance">
            <h2>Pontos por Over</h2>
            <svg viewBox="0 0 900 320"></svg>
        </section>
        <section class="card third" id="worm">
            <h2>Worm (Corrida Acumulada)</h2>
            <svg viewBox="0 0 900 320"></svg>
        </section>
        <section class="card third" id="manhattan">
            <h2>Manhattan (Runs por Over)</h2>
            <svg viewBox="0 0 900 320"></svg>
        </section>
        <section class="card third" id="fow">
            <h2>Queda de Wickets (FOW)</h2>
            <svg viewBox="0 0 900 320"></svg>
        </section>
        <section class="card third" id="batsmen">
            <h2>Batsmen</h2>
            <svg viewBox="0 0 900 420"></svg>
        </section>
        <section class="card third" id="bowlers">
            <h2>Bowlers</h2>
            <svg viewBox="0 0 900 420"></svg>
        </section>
        <section class="card third" id="recent">
            <h2>Overs Recentes</h2>
            <svg viewBox="0 0 900 240"></svg>
        </section>
        
    </main>

    <div class="tooltip" id="tip"></div>

</body>
<script>
    const params = new Proxy(new URLSearchParams(window.location.search), {
    get: (searchParams, prop) => searchParams.get(prop),
});
let ID = params.id;

async function fetchScorecard() {
    try {
        const response = await fetch(`https://lsc.fn.sportradar.com/common/en/Etc:UTC/cricket/get_scorecard/${ID}`);
        const scoreData = await response.json();
        const match = scoreData.doc[0].data.score;
        console.log(match);

        // Status da partida
        let status;
        switch(match.matchStatus){
            case 0: status = "Não iniciado"; break;
            case 1:
            case 2: status = "Em andamento"; break;
            case 3: status = "Finalizado"; break;
            default: status = "Indefinido";
        }

        document.getElementById('matchTitle').innerText = "Jogo: " + (match.matchTitle || 'Partida');
        document.getElementById('status').innerText = "Status: " + status;
        document.getElementById('idJogo').innerText = "ID: " + (ID || '—');

        // Times (seguro caso só tenha uma innings)
        const innings = match.innings || [];
        const time1Name = innings[0]?.teamName || "Time 1";
        const time2Name = innings[1]?.teamName || "Time 2";
        document.getElementById('teams').innerHTML = `<h2 class="timeaz">${time1Name}</h2> VS <h2 class="timever">${time2Name}</h2>`;

        // Renderiza gráficos
        renderCharts(match);

        // Reload a cada 30s
        setTimeout(fetchScorecard, 30000);
    } catch (error) {
        console.error('Erro ao buscar scorecard:', error);
        setTimeout(fetchScorecard, 30000);
    }
}

// Tooltip
const tip = d3.select('#tip');
const showTip = (html, evt)=>{
    tip.html(html).style('opacity',1).style('left',(evt.pageX+12)+'px').style('top',(evt.pageY-12)+'px');
};
const hideTip = ()=> tip.style('opacity',0);

// Renderização de gráficos
function renderCharts(score){
    const innings = score.innings?.[0];

    // Worm e Manhattan
    const wormData = (score.wormAndManhattan || [])
        .map(d=>{
            if(!d.firstInnings) return null;
            const [runs, wkts, cumRuns, totWkts] = d.firstInnings.split(',').map(Number);
            return {over:+d.overNumber, overRuns:runs, overWkts:wkts, cumRuns, totalWkts:totWkts};
        }).filter(Boolean);
    drawWorm('#worm svg', wormData);
    drawManhattan('#manhattan svg', wormData);

    // FOW (queda de wickets)
    const fow = (innings?.fallOfwickets || '').split(',').map(s=>s.trim()).filter(Boolean).map(s=>{
        const m = s.match(/(\S+)\s+(\d+)\/(\d+)\s*\((\d+)(?:\.(\d))?\)/);
        if(!m) return null;
        return { name:m[1], runs:+m[2], wkts:+m[3], over:+m[4]+(m[5]? +m[5]/6:0)};
    }).filter(Boolean);
    drawFOW('#fow svg', fow);

    // Batsmen
    const bat = (innings?.batsmen||[]).map(b=>({ name:b.batsmanName, runs:+b.runs||0, balls:+b.balls||0 })).sort((a,b)=>b.runs-a.runs);
    drawBatsmen('#batsmen svg', bat);

    // Bowlers
    const bowl = (innings?.bowlers||[]).map(b=>({ name:b.bowlerName, wickets:+b.wickets||0, runs:+b.runs||0, overs:+b.overs||0 })).sort((a,b)=>b.wickets-a.wickets);
    drawBowlers('#bowlers svg', bowl);

    // Overs recentes
    const recent = (score.recentOvers||[]).map(o=>({ over:o.overNumber, runs:o.runs }));
    drawRecent('#recent svg', recent);

    // Desempenho de times
    const totals = (score.innings||[]).map(i=>({ team:i.teamName, runs: parseInt(i.runs,10)||0 }));
    drawTeamPerformance('#teamPerformance svg', totals);

    // Performance por over
    const oversPerformance = (score.wormAndManhattan || []).map(d => {
        const runs1 = d.firstInnings ? +d.firstInnings.split(',')[0] : 0;
        const runs2 = d.secondInnings ? +d.secondInnings.split(',')[0] : 0;
        return { over: +d.overNumber, team1: runs1, team2: runs2 };
    });
    drawOverPerformance('#overPerformance svg', oversPerformance, score.innings?.map(i=>({teamName:i.teamName})) || []);
}

    function drawWorm(sel,data){
        const svg=d3.select(sel); svg.selectAll('*').remove();
        const W=900,H=320,m={t:20,r:20,b:40,l:50};
        const x=d3.scaleLinear().domain([1,d3.max(data,d=>d.over)||20]).range([m.l,W-m.r]);
        const y=d3.scaleLinear().domain([0,d3.max(data,d=>d.cumRuns)||0]).range([H-m.b,m.t]);
        const g=svg.append('g');
        g.append('g').attr('transform',`translate(0,${H-m.b})`).call(d3.axisBottom(x));
        g.append('g').attr('transform',`translate(${m.l},0)`).call(d3.axisLeft(y));
        const line=d3.line().x(d=>x(d.over)).y(d=>y(d.cumRuns));
        g.append('path').datum(data).attr('fill','none').attr('stroke','var(--accent)').attr('stroke-width',2).attr('d',line);
    }
    function drawManhattan(sel,data){
        const svg=d3.select(sel); svg.selectAll('*').remove();
        const W=900,H=320,m={t:20,r:20,b:40,l:40};
        const x=d3.scaleBand().domain(data.map(d=>d.over)).range([m.l,W-m.r]).padding(0.1);
        const y=d3.scaleLinear().domain([0,d3.max(data,d=>d.overRuns)||0]).range([H-m.b,m.t]);
        const g=svg.append('g');
        g.append('g').attr('transform',`translate(0,${H-m.b})`).call(d3.axisBottom(x));
        g.append('g').attr('transform',`translate(${m.l},0)`).call(d3.axisLeft(y));
        g.selectAll('rect').data(data).enter().append('rect').attr('x',d=>x(d.over)).attr('y',d=>y(d.overRuns)).attr('width',x.bandwidth()).attr('height',d=>y(0)-y(d.overRuns)).attr('fill','var(--accent)');
    }
    function drawFOW(sel,data){
        const svg=d3.select(sel); svg.selectAll('*').remove();
        const W=900,H=320,m={t:20,r:20,b:40,l:50};
        const x=d3.scaleLinear().domain([0,d3.max(data,d=>d.over)||20]).range([m.l,W-m.r]);
        const y=d3.scaleLinear().domain([0,d3.max(data,d=>d.runs)||0]).range([H-m.b,m.t]);
        const g=svg.append('g');
        g.append('g').attr('transform',`translate(0,${H-m.b})`).call(d3.axisBottom(x));
        g.append('g').attr('transform',`translate(${m.l},0)`).call(d3.axisLeft(y));
        g.selectAll('circle').data(data).enter().append('circle').attr('cx',d=>x(d.over)).attr('cy',d=>y(d.runs)).attr('r',5).attr('fill','#f87171');
    }
    function drawBatsmen(sel,data){
        const svg=d3.select(sel); svg.selectAll('*').remove();
        const W=900,H=420,m={t:20,r:20,b:40,l:100};
        const x=d3.scaleLinear().domain([0,d3.max(data,d=>d.runs)||0]).range([m.l,W-m.r]);
        const y=d3.scaleBand().domain(data.map(d=>d.name)).range([m.t,H-m.b]).padding(0.1);
        const g=svg.append('g');
        g.append('g').attr('transform',`translate(0,${H-m.b})`).call(d3.axisBottom(x));
        g.append('g').attr('transform',`translate(${m.l},0)`).call(d3.axisLeft(y));
        g.selectAll('rect').data(data).enter().append('rect').attr('x',x(0)).attr('y',d=>y(d.name)).attr('width',d=>x(d.runs)-x(0)).attr('height',y.bandwidth()).attr('fill','var(--accent)');
    }
    function drawBowlers(sel,data){
        const svg=d3.select(sel); svg.selectAll('*').remove();
        const W=900,H=420,m={t:20,r:20,b:40,l:120};
        const x=d3.scaleLinear().domain([0,d3.max(data,d=>d.wickets)||0]).range([m.l,W-m.r]);
        const y=d3.scaleBand().domain(data.map(d=>d.name)).range([m.t,H-m.b]).padding(0.1);
        const g=svg.append('g');
        g.append('g').attr('transform',`translate(0,${H-m.b})`).call(d3.axisBottom(x));
        g.append('g').attr('transform',`translate(${m.l},0)`).call(d3.axisLeft(y));
        g.selectAll('rect').data(data).enter().append('rect').attr('x',x(0)).attr('y',d=>y(d.name)).attr('width',d=>x(d.wickets)-x(0)).attr('height',y.bandwidth()).attr('fill','#f87171');
    }
    function drawRecent(sel,data){
        const svg=d3.select(sel); svg.selectAll('*').remove();
        const W=900,H=240,m={t:20,r:20,b:40,l:50};
        const x=d3.scaleBand().domain(data.map(d=>d.over)).range([m.l,W-m.r]).padding(0.1);
        const y=d3.scaleLinear().domain([0,d3.max(data,d=>d.runs)||0]).range([H-m.b,m.t]);
        const g=svg.append('g');
        g.append('g').attr('transform',`translate(0,${H-m.b})`).call(d3.axisBottom(x));
        g.append('g').attr('transform',`translate(${m.l},0)`).call(d3.axisLeft(y));
        g.selectAll('rect').data(data).enter().append('rect').attr('x',d=>x(d.over)).attr('y',d=>y(d.runs)).attr('width',x.bandwidth()).attr('height',d=>y(0)-y(d.runs)).attr('fill','var(--accent)');
    }

    function drawTeamPerformance(sel,data){
        const svg=d3.select(sel); svg.selectAll('*').remove();
        const W=900,H=320,m={t:20,r:20,b:40,l:100};
        const x=d3.scaleLinear().domain([0,d3.max(data,d=>d.runs)||0]).range([m.l,W-m.r]);
        const y=d3.scaleBand().domain(data.map(d=>d.team)).range([m.t,H-m.b]).padding(0.3);
        const colors=["#3b82f6","#f97316"];
        const g=svg.append('g');
        g.append('g').attr('transform',`translate(0,${H-m.b})`).call(d3.axisBottom(x));
        g.append('g').attr('transform',`translate(${m.l},0)`).call(d3.axisLeft(y));
        g.selectAll('rect').data(data).enter().append('rect')
          .attr('x',x(0)).attr('y',(d,i)=>y(d.team))
          .attr('width',d=>x(d.runs)-x(0)).attr('height',y.bandwidth())
          .attr('fill',(d,i)=>colors[i%colors.length]);
    }
    function drawOverPerformance(sel,data,teams){
        const svg=d3.select(sel); svg.selectAll('*').remove();
        const W=900,H=320,m={t:20,r:20,b:40,l:50};

        const x=d3.scaleBand().domain(data.map(d=>d.over)).range([m.l,W-m.r]).padding(0.2);
        const y=d3.scaleLinear().domain([0,d3.max(data,d=>Math.max(d.team1,d.team2))||0]).range([H-m.b,m.t]);
        const g=svg.append('g');

        g.append('g').attr('transform',`translate(0,${H-m.b})`).call(d3.axisBottom(x));
        g.append('g').attr('transform',`translate(${m.l},0)`).call(d3.axisLeft(y));

        const barWidth = x.bandwidth()/2;

        // Team 1 (azul)
        g.selectAll('.bar1').data(data).enter().append('rect')
          .attr('x',d=>x(d.over))
          .attr('y',d=>y(d.team1))
          .attr('width',barWidth)
          .attr('height',d=>y(0)-y(d.team1))
          .attr('fill','#3b82f6');

        // Team 2 (laranja)
        g.selectAll('.bar2').data(data).enter().append('rect')
          .attr('x',d=>x(d.over)+barWidth)
          .attr('y',d=>y(d.team2))
          .attr('width',barWidth)
          .attr('height',d=>y(0)-y(d.team2))
          .attr('fill','#f97316');

        // Legenda
        if(teams){
            svg.append('circle').attr('cx',W-150).attr('cy',30).attr('r',6).attr('fill','#3b82f6');
            svg.append('text').attr('x',W-140).attr('y',34).text(teams[0]?.teamName || 'Time 1').attr('fill','var(--text)').style('font-size','12px');

            svg.append('circle').attr('cx',W-150).attr('cy',50).attr('r',6).attr('fill','#f97316');
            svg.append('text').attr('x',W-140).attr('y',54).text(teams[1]?.teamName || 'Time 2').attr('fill','var(--text)').style('font-size','12px');
        }
    }


    document.addEventListener('DOMContentLoaded', fetchScorecard);
</script>
</html>
